# MASTER PLAN APP S·ªî THU CHI ‚Äì FINAL (C·∫¨P NH·∫¨T SETTINGS CHO C·∫¢ THU)

> **Nguy√™n t·∫Øc xuy√™n su·ªët**  
> * App ch·ªâ nh·∫≠p & g·ª≠i d·ªØ li·ªáu g·ªëc (∆∞u ti√™n flow vi·∫øt tay cho Chi)  
> * Google Sheet t√≠nh to√†n b·ªô c√¥ng th·ª©c (id, s·ªë d∆∞ LT, t·ªïng thu, s·ªë ti·ªÅn vnƒë)  
> * Settings l∆∞u LocalStorage, kh√¥ng l∆∞u d·ªØ li·ªáu ti·ªÅn  
> * Phong c√°ch UI: iOS-like 2026, tab bar, navigation m∆∞·ª£t, format s·ªë: . cho h√†ng ngh√¨n, , cho th·∫≠p ph√¢n (hi·ªÉn th·ªã), g·ª≠i n·ªôi b·ªô d√πng . th·∫≠p ph√¢n

---

## 1Ô∏è‚É£ T·ªîNG QUAN H·ªÜ TH·ªêNG

* Web App (SPA, phong c√°ch iOS: tab bar, navigation, swipe gestures)
* Database: **Google Sheets** (sync qua GAS)
* Kh√¥ng API ng√¢n h√†ng
* Kh√¥ng backend ph·ª©c t·∫°p
* LocalStorage: l∆∞u **UI settings** (8 m√¥ t·∫£ chi th∆∞·ªùng d√πng)
* CSDL l√† **source of truth**

---

## 2Ô∏è‚É£ C·∫§U TR√öC CSDL (KH·ªöP HO√ÄN TO√ÄN V·ªöI FILE EXCEL M·ªöI)

### C√°c sheet ch√≠nh:

* `Chi_Tieu_2026`
* `Thu_2026`
* `loai_chi`
* `nguon_tien`
* `tk_session`
* `tk_detail`

### Header c·∫≠p nh·∫≠t (kh·ªõp Excel):

- **Chi_Tieu_2026**: IDChi (t·ª± sinh), mo_ta_chi, Ngu·ªìn ti·ªÅn, Ngh√¨n VND, S·ªë ti·ªÅn vnƒë (formula), Ng√†y, S·ªë d∆∞ l√Ω thuy·∫øt (formula)
- **Thu_2026**: Thu, Ng√†y, M√¥ t·∫£, Ngu·ªìn ti·ªÅn, Lo·∫°i thu, T·ªïng thu (formula), IDThu (t·ª± sinh)
- **loai_chi**: id_chi (t·ª± sinh), mo_ta_chi, phan_loai, nhom, icon, active, sort_order, note
- **nguon_tien**: nguon_tien, nguoi, nhom, icon, active, note
- **tk_session**: session_id (t·ª± sinh), ngay_tk, so_du_lt, so_du_tt, chenhlech (formula), status, note
- **tk_detail**: session_id, ngay_tk, nguon_tien, so_tien

### Ng√†y th√°ng:
- CSDL: s·ªë serial (e.g., 46027 = 01/01/2026)
- App: hi·ªÉn th·ªã DD/MM/YYYY (e.g., 30/01/2026), g·ª≠i YYYY-MM-DD cho GAS (GAS convert sang serial)

---

## 3Ô∏è‚É£ QUY ∆Ø·ªöC D·ªÆ LI·ªÜU CHUNG (R·∫§T QUAN TR·ªåNG, KH·ªöP FLOW)

### üîí mo_ta_chi (trong Chi_Tieu_2026)
* = loai_chi.mo_ta_chi (string t·ª´ dropdown/8 n√∫t nhanh)
* App **ch·ªâ cho ch·ªçn 1** (theo flow: "ch·ªâ ƒë∆∞·ª£c ch·ªçn 1 m√¥ t·∫£")
* N·∫øu th√™m m·ªõi: app g·ª≠i insertLoaiChi (mo_ta_chi m·ªõi, phan_loai, nhom, icon m·∫∑c ƒë·ªãnh, active=true, sort_order max+1)

### üîí Ngu·ªìn ti·ªÅn
* = nguon_tien.nguon_tien (string t·ª´ dropdown)
* App **ch·ªâ cho ch·ªçn**, kh√¥ng g√µ tay, l·ªçc active=true

### üîí Lo·∫°i thu (trong Thu_2026)
* String t·ª± do (e.g., "Ng√¢n h√†ng", "Nh√† tr·ªç")

### üîí ID t·ª± sinh
* IDChi/IDThu/session_id: Sheet/GAS t·ª± t·∫°o (e.g., c1, t1, s1), app kh√¥ng g·ª≠i

### üîí S·ªë ti·ªÅn
* Chi: Ngh√¨n VND = c√¥ng th·ª©c string (e.g., "=25+35"), app g·ªôp t·ª´ tempList
* Thu: Thu = number VNƒê ƒë·∫ßy ƒë·ªß (e.g., 60000, app *1000 t·ª´ input)

---

## 4Ô∏è‚É£ GIAO DI·ªÜN & LU·ªíNG NG∆Ø·ªúI D√ôNG (∆ØU TI√äN FLOW VI·∫æT TAY)

---

## A. HEADER & SETTINGS

### M·ªü app (Home Screen)
* Hi·ªÉn th·ªã th√¥ng b√°o chi cu·ªëi: "Chi cu·ªëi <mo_ta_chi> Th·ª© <th·ª© t·ª´ ng√†y> ng√†y <DD/MM> t·ªïng <c√¥ng th·ª©c Ngh√¨n VND> = <S·ªë ti·ªÅn vnƒë format .,,>, s·ªë d∆∞ <S·ªë d∆∞ l√Ω thuy·∫øt format .,,>"
* Tab bar: Chi | Thu | T·ªïng k·∫øt | Settings

### Settings (m√†n h√¨nh ch√≠nh ‚Äì t·ªï ch·ª©c r√µ r√†ng, h·ªó tr·ª£ c·∫£ Chi & Thu)

C·∫•u tr√∫c Settings chia th√†nh c√°c section r√µ r√†ng, d·ªÖ scroll:

1. **M√¥ t·∫£ Chi th∆∞·ªùng d√πng** (Quick Chips cho ph·∫ßn Chi)
   - Ch·ªçn t·ªëi ƒëa 8 mo_ta_chi t·ª´ danh s√°ch loai_chi (active=true, sort by sort_order)
   - Hi·ªÉn th·ªã d·∫°ng grid 2x4 ho·∫∑c carousel ngang
   - N√∫t "Qu·∫£n l√Ω" ‚Üí m·ªü list ƒë·∫ßy ƒë·ªß ƒë·ªÉ ch·ªçn/thay ƒë·ªïi th·ª© t·ª±
   - L∆∞u v√†o LocalStorage: array<string> (8 mo_ta_chi)

2. **M√¥ t·∫£ Thu th∆∞·ªùng d√πng** (Quick Chips cho ph·∫ßn Thu) ‚Äì **M·ªöI**
   - T∆∞∆°ng t·ª± ph·∫ßn Chi: ch·ªçn t·ªëi ƒëa 8 m√¥ t·∫£ thu nh·∫≠p th∆∞·ªùng d√πng (text t·ª± do)
   - Ng∆∞·ªùi d√πng nh·∫≠p tay ho·∫∑c ch·ªçn t·ª´ l·ªãch s·ª≠ Thu g·∫ßn ƒë√¢y (n·∫øu c√≥)
   - Hi·ªÉn th·ªã grid 2x4
   - L∆∞u LocalStorage: array<string> (8 mo_ta th∆∞·ªùng d√πng cho Thu)

3. **Lo·∫°i thu th∆∞·ªùng d√πng** (Quick select cho ph·∫ßn Thu) ‚Äì **M·ªöI**
   - Ch·ªçn t·ªëi ƒëa 5‚Äì8 lo·∫°i thu ph·ªï bi·∫øn (v√≠ d·ª•: "Ng√¢n h√†ng", "Nh√† tr·ªç", "Cho m∆∞·ª£n", "Kh√°c", "L√£i su·∫•t", "B√°n ƒë·ªì c≈©"...)
   - C√≥ th·ªÉ nh·∫≠p tay ho·∫∑c l·∫•y t·ª´ l·ªãch s·ª≠
   - Hi·ªÉn th·ªã d·∫°ng tag/chip, d·ªÖ ch·ªçn nhanh trong ph·∫ßn Thu
   - L∆∞u LocalStorage: array<string>

4. **C√†i ƒë·∫∑t chung**
   - Locale & Format s·ªë (m·∫∑c ƒë·ªãnh VN: . ngh√¨n, , th·∫≠p ph√¢n)
   - Dark/Light mode
   - Th√¥ng b√°o push (n·∫øu c√≥ sau n√†y)
   - Backup/Export sheet link
   - Reset settings (x√≥a LocalStorage)

5. **D·ªØ li·ªáu n·ªÅn (read-only, xem ƒë·ªÉ tham kh·∫£o)**
   - Danh s√°ch t·∫•t c·∫£ nguon_tien (active)
   - Danh s√°ch t·∫•t c·∫£ loai_chi (active)

‚Üí **L·ª£i √≠ch**: Settings gi·ªù ƒë·ªëi x·ª©ng ho√†n to√†n gi·ªØa Chi v√† Thu ‚Üí ng∆∞·ªùi d√πng c√≥ th·ªÉ c·∫•u h√¨nh nhanh c·∫£ hai ph·∫ßn m√† kh√¥ng c·∫ßn v√†o m√†n h√¨nh Chi/Thu ri√™ng l·∫ª.

---

## B. PH·∫¶N CHI TI√äU (EXPENSE) ‚Äì KH·ªöP FLOW

### 1. Ch·ªçn ng√†y
* 3 n√∫t: << (l√πi ng√†y), [Ng√†y hi·ªán t·∫°i ‚Äì nh·∫•n m·ªü date picker], >> (ti·∫øn ng√†y)
* M·∫∑c ƒë·ªãnh: h√¥m nay (YYYY-MM-DD)

### 2. Nh·∫≠p s·ªë ti·ªÅn (Calculator ‚Äì h·ªó tr·ª£ +)
* Ghi ch√∫: "x 1000" (hi·ªÉn th·ªã d∆∞·ªõi textbox)
* Textbox nh·∫≠p: g√µ s·ªë/th·∫≠p ph√¢n (d√πng , cho th·∫≠p ph√¢n, app convert sang . n·ªôi b·ªô)
* Nh·∫•n +: th√™m v√†o tempList, hi·ªÉn th·ªã ngay d∆∞·ªõi: "25.000 + 35.000 = 60.000" (format . .)
* S·ª≠a: nh·∫•n v√†o "25.000" ‚Üí load 25 v√†o textbox, qu√©t kh·ªëi s·∫µn, s·ª≠a ‚Üí update tempList
* N·∫øu blur textbox m√† kh√¥ng thay ƒë·ªïi: x√°c nh·∫≠n
* N√∫t X√≥a: x√≥a tempItem cu·ªëi
* N√∫t Reset: x√≥a h·∫øt tempList (kh√¥ng reset mo_ta_chi/ngu·ªìn)
* N·ªôi b·ªô: tempList = [{id: uuid, value: number}]

### 3. Ch·ªçn mo_ta_chi
* 8 n√∫t nhanh (chip, t·ª´ settings, icon t·ª´ loai_chi.icon)
* Dropdown: c√°c mo_ta_chi c√≤n l·∫°i (active=true, sort_order)
* Ch·ªâ ch·ªçn 1 (n√∫t ƒë·ªôc quy·ªÅn)
* N√∫t "Th√™m m·ªõi": popup v·ªõi fields: mo_ta_chi (text), phan_loai (dropdown t·ª´ distinct loai_chi.phan_loai), nhom (dropdown t·ª´ distinct loai_chi.nhom)
* N√∫t Th√™m enable khi ƒë·ªß ‚Üí g·ª≠i insertLoaiChi qua GAS, refresh dropdown

### 4. Ch·ªçn ngu·ªìn ti·ªÅn
* Dropdown: nguon_tien.nguon_tien (active=true, render icon)
* B·∫Øt bu·ªôc ch·ªçn

### 5. Submit Chi
* N√∫t "Th√™m chi ti√™u" enable khi: tempList >=1, mo_ta_chi, ngu·ªìn ti·ªÅn
* App g·ªôp: so_tien_nghin = "=" + tempList.map(v => v.value).join("+")
* G·ª≠i payload Chi qua GAS
* Th√¥ng b√°o: "ƒê√£ th√™m v√†o chi ti√™u <mo_ta_chi> <tempList format .000 + ...> = <t·ªïng vnƒë> ngu·ªìn <ngu·ªìn ti·ªÅn> Th·ª© <th·ª©> ng√†y <DD/MM/YYYY> th√†nh c√¥ng"
* Reload chi cu·ªëi, reset form ch·ªù nh·∫≠p m·ªõi

---

## C. PH·∫¶N THU NH·∫¨P (INCOME) ‚Äì ƒê∆Ø·ª¢C C·∫¢I THI·ªÜN NH·ªú SETTINGS

* Ng√†y: 3 n√∫t <<, Ng√†y hi·ªán t·∫°i (date picker), >>
* S·ªë ti·ªÅn: 1 textbox l·ªõn (VNƒê ƒë·∫ßy ƒë·ªß), t·ª± format . cho h√†ng ngh√¨n khi g√µ (v√≠ d·ª• g√µ 60000 ‚Üí "60.000")
* M√¥ t·∫£: 
  - 8 quick chips (t·ª´ Settings ph·∫ßn "M√¥ t·∫£ Thu th∆∞·ªùng d√πng")
  - Dropdown c√°c m√¥ t·∫£ c≈© (t·ª´ l·ªãch s·ª≠ Thu)
  - Text t·ª± do n·∫øu kh√¥ng ch·ªçn quick
* Lo·∫°i thu:
  - Quick chips/tags t·ª´ Settings ph·∫ßn "Lo·∫°i thu th∆∞·ªùng d√πng" (5‚Äì8 c√°i)
  - Dropdown l·ªãch s·ª≠ ho·∫∑c text t·ª± do
* Ngu·ªìn ti·ªÅn: dropdown (active=true, icon)
* N√∫t "Th√™m thu nh·∫≠p" enable khi ƒë·ªß fields
* Submit ‚Üí th√¥ng b√°o: "ƒê√£ th√™m thu <M√¥ t·∫£> <s·ªë ti·ªÅn format> ngu·ªìn <ngu·ªìn> Th·ª© <th·ª©> ng√†y <DD/MM/YYYY> th√†nh c√¥ng"
* Reload thu cu·ªëi (n·∫øu mu·ªën hi·ªÉn th·ªã t∆∞∆°ng t·ª± chi cu·ªëi), reset form

‚Üí Ph·∫ßn Thu gi·ªù nhanh t∆∞∆°ng ƒë∆∞∆°ng Chi nh·ªù quick chips t·ª´ Settings.

---

## D. PH·∫¶N T·ªîNG K·∫æT (SUMMARY) ‚Äì KH·ªöP FLOW

### 1. Nh·∫•n "L√†m t·ªïng k·∫øt"
* Load: so_du_lt (t·ª´ Sheet Chi cu·ªëi), danh s√°ch nguon_tien (active=true)

### 2. Nh·∫≠p s·ªë d∆∞ th·ª±c t·∫ø
* V·ªõi m·ªói nguon_tien: 1 textbox (format t·ª± ƒë·ªông: g√µ 1253251157 ‚Üí "1.253.251,157" n·∫øu th·∫≠p ph√¢n, nh∆∞ng th∆∞·ªùng nguy√™n)
* App t√≠nh so_du_tt = sum t·∫•t c·∫£ input

### 3. Ki·ªÉm tra & Ch·ªânh s·ª≠a
* N√∫t "Ki·ªÉm tra" enable khi ƒë·ªß input
* T√≠nh chenhlech = so_du_lt - so_du_tt (hi·ªÉn th·ªã ngay)
* Hi·ªÉn th·ªã: "T·ª´ ng√†y <ng√†y tk tr∆∞·ªõc +1> ƒë·∫øn ng√†y hi·ªán t·∫°i\nS·ªë d∆∞ LT: <format>\nS·ªë d∆∞ TT: <format>\nCh√™nh l·ªách: <format> (Thi·∫øu/Th·ª´a)"
* B·∫£ng chi ti·∫øt chi theo ngu·ªìn: "Ngu·ªìn A: <t·ªïng chi t·ª´ ngu·ªìn A trong k·ª≥> [n√∫t xem chi ti·∫øt]"
* N√∫t xem: load list Chi t·ª´ ngu·ªìn ƒë√≥ (trong k·ª≥: t·ª´ ng√†y tk tr∆∞·ªõc +1 ƒë·∫øn nay)
  - List: mo_ta_chi, Ngh√¨n VND (c√¥ng th·ª©c), S·ªë ti·ªÅn vnƒë, Ng√†y
  - Cho s·ª≠a Ngh√¨n VND (c√¥ng th·ª©c, nh∆∞ calculator)
  - N√∫t "X√°c nh·∫≠n s·ª≠a": g·ª≠i updateChi qua GAS, reload t·ªïng k·∫øt, update chenhlech

### 4. Submit T·ªïng k·∫øt
* Khi ·ªïn ‚Üí nh·∫•n "X√°c nh·∫≠n t·ªïng k·∫øt"
* App sinh session_id = max +1 (e.g., s4)
* G·ª≠i payload TK (tk_session + tk_detail rows)
* Th√¥ng b√°o: "ƒê√£ t·ªïng k·∫øt th√†nh c√¥ng k·ª≥ t·ª´ ng√†y - ng√†y... s·ªë d∆∞ LT:... TT:... ch√™nh l·ªách...."
* Status = "confirmed"

---

## 5Ô∏è‚É£ LOGIC K·ª∏ THU·∫¨T (C·∫¨P NH·∫¨T)

### 5.1 State Management
* tempList: TempItem[] (cho Chi)
* selectedMoTaChi: string
* selectedNguonTien: string
* tkInputs: { [nguon_tien: string]: number } (so_du_tt)
* quickMoTaChi: string[] (t·ª´ LocalStorage, max 8)
* quickMoTaThu: string[] (t·ª´ LocalStorage, max 8)
* quickLoaiThu: string[] (t·ª´ LocalStorage, max 8)

### 5.2 Load Settings
- Khi m·ªü app: ƒë·ªçc LocalStorage ‚Üí n·∫øu ch∆∞a c√≥, g·ª£i √Ω m·∫∑c ƒë·ªãnh (v√≠ d·ª• 8 mo_ta_chi ph·ªï bi·∫øn t·ª´ loai_chi sort_order th·∫•p nh·∫•t)

### 5.3 Nguy√™n t·∫Øc v√†ng
* Sheet: lo c√¥ng th·ª©c, id
* App: g·ª≠i d·ªØ li·ªáu g·ªëc, format hi·ªÉn th·ªã ri√™ng
* TK: snapshot + h·ªó tr·ª£ s·ª≠a Chi (qua GAS updateChi)

---

## ‚úÖ K·∫æT LU·∫¨N CU·ªêI

* MP ƒë√£ ch·ªânh kh·ªõp CSDL m·ªõi + ∆∞u ti√™n flow vi·∫øt tay
* Th√™m h·ªó tr·ª£ s·ª≠a Chi trong t·ªïng k·∫øt (kh√¥ng m√¢u thu·∫´n, v√¨ update qua GAS)
* Settings ƒë√£ ƒë∆∞·ª£c t·ªï ch·ª©c **ƒë·∫ßy ƒë·ªß v√† ƒë·ªëi x·ª©ng** cho c·∫£ Chi v√† Thu: quick chips m√¥ t·∫£ + lo·∫°i thu ‚Üí l√†m cho ph·∫ßn Thu nhanh, ti·ªán l·ª£i t∆∞∆°ng t·ª± Chi.
* Ph·∫ßn Thu gi·ªù nhanh t∆∞∆°ng ƒë∆∞∆°ng Chi nh·ªù quick chips t·ª´ Settings.
* MP ƒë√≥ng, s·∫µn s√†ng code front-end (React/Vue + Tailwind cho iOS style) v√† GAS backend.

---

## 6Ô∏è‚É£ PAYLOAD SPEC (KH·ªöP GAS & CSDL)

### ChiPayload
```ts
export interface ChiPayload {
  ngay: string;          // YYYY-MM-DD
  so_tien_nghin: string; // "=25+35" (c√¥ng th·ª©c)
  mo_ta_chi: string;     // t·ª´ loai_chi.mo_ta_chi
  nguon_tien: string;    // t·ª´ nguon_tien
}
```

### ThuPayload
```ts
export interface ThuPayload {
  ngay: string;       // YYYY-MM-DD
  so_tien: number;    // VNƒê ƒë·∫ßy ƒë·ªß (>0)
  mo_ta: string;      // text t·ª± do
  loai_thu: string;   // text t·ª± do
  nguon_tien: string;
}
```

### TKDetail
```ts
export interface TKDetail {
  nguon_tien: string;
  so_tien: number;    // so_du_tt VNƒê
}
```

### TKPayload
```ts
export interface TKPayload {
  ngay_tk: string;     // YYYY-MM-DD
  so_du_lt: number;    // t·ª´ Sheet
  chi_tiet: TKDetail[];
  note?: string;
}
```

### Union Request (POST /append)
```ts
export type AppRequest =
  | { type: "chi"; payload: ChiPayload }
  | { type: "thu"; payload: ThuPayload }
  | { type: "tk"; payload: TKPayload }
  | { type: "insert_loai_chi"; payload: { mo_ta_chi: string; phan_loai: string; nhom: string; icon?: string } }  // Th√™m m·ªõi
  | { type: "update_chi"; payload: { idChi: string; so_tien_nghin: string } };  // S·ª≠a trong TK
```

### Validation Helper
```ts
export function isPositiveNumber(n: number): boolean {
  return Number.isFinite(n) && n > 0;
}
```

---

## 7Ô∏è‚É£ V√ç D·ª§ S·ª¨ D·ª§NG

```ts
const chiReq: AppRequest = {
  type: "chi",
  payload: {
    ngay: "2026-01-30",
    so_tien_nghin: "=25+35",
    mo_ta_chi: "ƒêi ch·ª£",
    nguon_tien: "Tech M√®o"
  }
};
```