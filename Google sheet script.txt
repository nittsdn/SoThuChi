// --- CẤU HÌNH ---
const SHEET_NAME = "Chi Tiêu 2026"; 

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000); 

  try {
    const doc = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = doc.getSheetByName(SHEET_NAME);
    if (!sheet) sheet = doc.getSheets()[0]; 

    const request = JSON.parse(e.postData.contents);
    const type = request.type; 
    const dataRows = request.data; 

    if (type === 'chi') {
      let lastRow = getLastRowInColumn(sheet, 1); 
      dataRows.forEach(row => {
        lastRow++;
        row[0] = lastRow - 1; // Cập nhật lại STT chuẩn
        sheet.getRange(lastRow, 1, 1, 5).setValues([row]);
      });
    } 
    else if (type === 'thu') {
      let lastRow = getLastRowInColumn(sheet, 10);
      dataRows.forEach(row => {
        lastRow++;
        sheet.getRange(lastRow, 10, 1, 3).setValues([row]);
      });
    }

    return ContentService.createTextOutput(JSON.stringify({ status: "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", msg: err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

function getLastRowInColumn(sheet, column) {
  const lastRow = sheet.getLastRow();
  if (lastRow === 0) return 0;
  const range = sheet.getRange(1, column, lastRow);
  const values = range.getValues();
  for (let i = values.length - 1; i >= 0; i--) {
    if (values[i][0] !== "" && values[i][0] !== null) return i + 1;
  }
  return 0;
}