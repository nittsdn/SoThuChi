// --- CẤU HÌNH ---
const SHEET_NAME = "Chi_Tieu_2026";

function doPost(e) {
  const lock = LockService.getScriptLock();
  if (!lock.tryLock(10000)) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", msg: "Lock failed" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const doc = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = doc.getSheetByName(SHEET_NAME);
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({ status: "error", msg: "Sheet not found: " + SHEET_NAME }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    const request = JSON.parse(e.postData.contents);
    const type = request.type; 
    const dataRows = request.data; 

    Logger.log("Request type: " + type + ", dataRows length: " + dataRows.length);

    if (type === 'chi') {
      let lastRow = getLastRowInColumn(sheet, 1) + 1;
      Logger.log("Chi LastRow calculated: " + lastRow);
      dataRows.forEach(row => {
        const lastSTT = parseInt(sheet.getRange(getLastRowInColumn(sheet, 1), 1).getValue()) || 0;
        row[0] = lastSTT + 1;
        row[4] = new Date();
        sheet.getRange(lastRow, 1, 1, 5).setValues([row]);
        sheet.getRange(lastRow, 5).setNumberFormat("dddd-dd/mm/yy");
        Logger.log("Chi row added at " + lastRow + ": " + JSON.stringify(row));
        Logger.log("Verify A" + lastRow + ": " + sheet.getRange(lastRow, 1).getValue());
        lastRow++;
      });
    } 
    else if (type === 'thu') {
      // SỬA: Dùng hàm riêng getLastRowForThu
      let lastRow = getLastRowForThu(sheet) + 1;
      Logger.log("Thu LastRow calculated: " + lastRow);
      dataRows.forEach(row => {
        sheet.getRange(lastRow, 9).setValue(row[0]);
        sheet.getRange(lastRow, 10).setValue(row[1]);
        sheet.getRange(lastRow, 11).setValue(row[2]);
        sheet.getRange(lastRow, 10).setNumberFormat("dddd-dd/mm/yy");
        Logger.log("Thu row added at " + lastRow + ": J=" + row[0] + ", K=" + row[1] + ", L=" + row[2]);
        Logger.log("Verify J" + lastRow + ": " + sheet.getRange(lastRow, 9).getValue());
        lastRow++;
      });
    }

    return ContentService.createTextOutput(JSON.stringify({ status: "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log("Script error: " + err);
    return ContentService.createTextOutput(JSON.stringify({ status: "error", msg: err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

function testDoPost() {
  const mockEChi = {
    postData: {
      contents: JSON.stringify({
        type: 'chi',
        data: [
          [0, 'Ăn sáng, đi chợ', 25, 25000, 'placeholder']
        ]
      })
    }
  };

  const resultChi = doPost(mockEChi);
  Logger.log("Test Chi result: " + resultChi.getContent());

  const mockEThu = {
    postData: {
      contents: JSON.stringify({
        type: 'thu',
        data: [
          [25000, 'placeholder', 'Lãi Tech']
        ]
      })
    }
  };

  const resultThu = doPost(mockEThu);
  Logger.log("Test Thu result: " + resultThu.getContent());
}

// SỬA: Hàm riêng cho thu
function getLastRowForThu(sheet) {
  const columns = [9, 10, 11]; // J, K, L
  const lastRow = sheet.getLastRow();
  if (lastRow === 0) return 0;
  const ranges = columns.map(col => sheet.getRange(1, col, lastRow));
  const values = ranges.map(range => range.getValues());
  for (let i = lastRow - 1; i >= 0; i--) {
    const hasData = columns.some((col, idx) => values[idx][i][0] !== "" && values[idx][i][0] !== null);
    if (hasData) return i + 1;
  }
  return 0;
}

function getLastRowInColumn(sheet, column) {
  const lastRow = sheet.getLastRow();
  if (lastRow === 0) return 0;
  const range = sheet.getRange(1, column, lastRow);
  const values = range.getValues();
  for (let i = values.length - 1; i >= 0; i--) {
    if (values[i][0] !== "" && values[i][0] !== null) return i + 1;
  }
  return 0;
}