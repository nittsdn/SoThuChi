Ok, mÃ¬nh **Ä‘Ã£ chá»‰nh láº¡i MP cho ÄÃšNG 100% vá»›i CSDL hiá»‡n táº¡i cá»§a báº¡n** vÃ  **Ä‘Ã³ng MP á»Ÿ tráº¡ng thÃ¡i â€œÄ‘á»§ Ä‘á»ƒ code â€“ khÃ´ng pháº£i quay láº¡i sá»­aâ€**.
DÆ°á»›i Ä‘Ã¢y lÃ  **MP FINAL (Ä‘Ã£ Ä‘á»“ng bá»™ Chi / Thu / TK / loai_chi / nguon_tien)**. Báº¡n cÃ³ thá»ƒ **copy lÆ°u láº¡i lÃ m tÃ i liá»‡u gá»‘c**.

---

# MASTER PLAN APP Sá»” THU CHI â€“ FINAL (SYNC WITH CSDL)

> **NguyÃªn táº¯c xuyÃªn suá»‘t**
>
> * App **chá»‰ nháº­p & gá»­i dá»¯ liá»‡u gá»‘c**
> * Google Sheet **tÃ­nh toÃ n bá»™ cÃ´ng thá»©c**
> * KhÃ´ng suy diá»…n, khÃ´ng tÃ­nh thay Sheet
> * Tá»•ng káº¿t = snapshot, khÃ´ng sinh Thu/Chi

---

## 1ï¸âƒ£ Tá»”NG QUAN Há»† THá»NG

* Web App (SPA)
* Database: **Google Sheets**
* KhÃ´ng API ngÃ¢n hÃ ng
* KhÃ´ng backend phá»©c táº¡p
* LocalStorage: chá»‰ lÆ°u **UI settings**
* CSDL lÃ  **source of truth**

---

## 2ï¸âƒ£ Cáº¤U TRÃšC CSDL (Ä‘Ã£ chá»‘t)

### CÃ¡c sheet chÃ­nh:

* `Chi_Tieu_2026`
* `Thu_2026`
* `loai_chi`
* `nguon_tien`
* `tk_session`
* `tk_detail`

---

## 3ï¸âƒ£ QUY Æ¯á»šC Dá»® LIá»†U CHUNG (Ráº¤T QUAN TRá»ŒNG)

### ğŸ”’ Nguá»“n tiá»n

* `Chi / Thu.Nguá»“n tiá»n`
* **= nguon_tien.ten_nguon_tien (string tuyá»‡t Ä‘á»‘i)**
* App **chá»‰ cho chá»n dropdown**, khÃ´ng gÃµ tay

### ğŸ”’ Loáº¡i chi

* `Chi_Tieu_2026.Loáº¡i chi`
* **= loai_chi.ten_loai_chi**
* Dropdown tá»« `loai_chi_active` (active = TRUE)

---

## 4ï¸âƒ£ GIAO DIá»†N & LUá»’NG NGÆ¯á»œI DÃ™NG

---

## A. HEADER & SETTINGS

### Header

* TÃªn app
* NgÃ y hiá»‡n táº¡i
* ThÃ´ng bÃ¡o chi/thu gáº§n nháº¥t

### Settings

* Chá»n 8 mÃ´ táº£ chi thÆ°á»ng dÃ¹ng
* LÆ°u LocalStorage
* **KhÃ´ng lÆ°u dá»¯ liá»‡u tiá»n**

---

## B. PHáº¦N CHI TIÃŠU (EXPENSE)

### 1. Calculator (GIá»® NGUYÃŠN)

* `tempList = [{ id, value }]`
* Add / Edit / Confirm / Delete
* Reset toÃ n bá»™

### 2. MÃ´ táº£

* 8 chip nhanh
* Dropdown
* Text tá»± do
* Báº¯t buá»™c â‰¥ 1 mÃ´ táº£
* App gá»™p thÃ nh **1 chuá»—i mÃ´ táº£**

### 3. Loáº¡i chi

* 1 dropdown
* Load tá»«:

  ```
  loai_chi_active
  ```
* KhÃ´ng cho nháº­p tay

### 4. Nguá»“n tiá»n

* 1 dropdown
* Load tá»«:

  ```
  nguon_tien WHERE active = TRUE
  ```
* Báº¯t buá»™c chá»n

### 5. Submit Chi

App gá»­i:

* `ngay`
* `tong_tien` (tá»•ng tempList)
* `mo_ta` (Ä‘Ã£ gá»™p)
* `loai_chi`
* `nguon_tien`

ğŸ‘‰ Sheet:

* tá»± tÃ­nh sá»‘ dÆ° lÃ½ thuyáº¿t
* app **khÃ´ng gá»­i, khÃ´ng tÃ­nh**

---

## C. PHáº¦N THU NHáº¬P (INCOME)

### Giá»‘ng Chi 95%

KhÃ¡c:

* CÃ³ **Loáº¡i thu**
* CÃ³ **Nguá»“n tiá»n (báº¯t buá»™c)**

### DÃ²ng Ä‘áº·c biá»‡t

* â€œSá»‘ dÆ° Ä‘áº§u nÄƒm / dÆ° nÄƒm trÆ°á»›câ€
* Chá»‰ dÃ¹ng khi khá»Ÿi táº¡o

### Submit Thu

App gá»­i:

* `ngay`
* `so_tien`
* `mo_ta`
* `loai_thu`
* `nguon_tien`

ğŸ‘‰ Sheet tá»± tÃ­nh `Tá»•ng thu`

---

## D. PHáº¦N Tá»”NG Káº¾T (SUMMARY â€“ SNAPSHOT)

### 1. Load dá»¯ liá»‡u

* Load:

  * `so_du_lt` (tá»« Sheet)
  * danh sÃ¡ch `nguon_tien (active)`

### 2. Render UI

* Vá»›i má»—i nguá»“n tiá»n:

  * icon
  * 1 input **sá»‘ dÆ° thá»±c**
* App auto cá»™ng:

  ```
  so_du_tt = sum(all inputs)
  ```

### 3. Hiá»ƒn thá»‹

* `chenh_lech = so_du_lt - so_du_tt`
* Hiá»ƒn thá»‹ realtime

### 4. Submit Tá»•ng káº¿t

App ghi:

* 1 dÃ²ng â†’ `tk_session`
* N dÃ²ng â†’ `tk_detail`

âŒ **KHÃ”NG sinh Thu**
âŒ **KHÃ”NG sinh Chi**

ğŸ‘‰ Náº¿u lá»‡ch â†’ quay láº¡i sá»­a Chi / Thu

---

## 5ï¸âƒ£ STATE MANAGEMENT (APP)

* `tempList` â€“ calculator
* `editingIndex`
* `selectedLoaiChi`
* `selectedNguonTien`
* `tkInputs = { nguon_tien: so_du_tt }`

---

## 6ï¸âƒ£ NGUYÃŠN Táº®C VÃ€NG (ÄÃ“NG MP)

* Sheet lo cÃ´ng thá»©c
* App chá»‰ gá»­i dá»¯ liá»‡u gá»‘c
* KhÃ´ng suy Ä‘oÃ¡n
* KhÃ´ng hardcode nguá»“n tiá»n / loáº¡i chi
* Má»i dropdown Ä‘á»u load tá»« Sheet

---

## âœ… TRáº NG THÃI CUá»I

* âœ” MP Ä‘Ã£ **Ä‘á»“ng bá»™ hoÃ n toÃ n vá»›i CSDL**
* âœ” KhÃ´ng dÆ° tÃ­nh nÄƒng
* âœ” KhÃ´ng mÃ¢u thuáº«n
* âœ” Code theo lÃ  cháº¡y, **khÃ´ng pháº£i quay láº¡i sá»­a MP**

ğŸ‘‰ **MP CHÃNH THá»¨C ÄÃ“NG á» ÄÃ‚Y.**

---

### BÆ°á»›c tiáº¿p theo há»£p lÃ½ nháº¥t

ğŸ‘‰ **Viáº¿t payload spec FINAL** cho:

* Chi
* Thu
* Tá»•ng káº¿t (TK)

Náº¿u báº¡n ok, chá»‰ cáº§n nÃ³i:
**â€œviáº¿t payload specâ€**
mÃ¬nh sáº½ lÃ m ngay, Ä‘Ãºng theo MP nÃ y.

Ok, mÃ¬nh viáº¿t **PAYLOAD SPEC FINAL** Ä‘Ãºng **100% theo MP + CSDL hiá»‡n táº¡i**, Ä‘á»ƒ báº¡n **Ä‘Æ°a tháº³ng cho front-end + GAS code**, khÃ´ng suy Ä‘oÃ¡n, khÃ´ng lá»‡ch cá»™t.

MÃ¬nh chia rÃµ **3 payload**: **Chi â€“ Thu â€“ Tá»•ng káº¿t (TK)**.
ÄÃ¢y lÃ  báº£n **CHá»T**, sau nÃ y chá»‰ má»Ÿ rá»™ng, **khÃ´ng sá»­a ngÆ°á»£c**.

---

# ğŸ“¦ PAYLOAD SPEC â€“ FINAL

## NGUYÃŠN Táº®C CHUNG (ÃP Dá»¤NG CHO Táº¤T Cáº¢)

* App **chá»‰ gá»­i dá»¯ liá»‡u gá»‘c**
* App **khÃ´ng gá»­i cá»™t cÃ³ cÃ´ng thá»©c**
* App **khÃ´ng gá»­i icon / id phá»¥**
* Má»i dropdown:

  * láº¥y tá»« Sheet
  * gá»­i **string Ä‘Ãºng chuáº©n**

---

# 1ï¸âƒ£ PAYLOAD: CHI TIÃŠU

### ğŸ¯ Má»¥c tiÃªu

Ghi **1 dÃ²ng** vÃ o sheet `Chi_Tieu_2026`

---

### ğŸ“Œ Payload (JSON)

```json
{
  "type": "chi",
  "payload": {
    "ngay": "2026-01-20",
    "so_tien": 55000,
    "mo_ta": "Ä‘i chá»£ + tiá»n nÆ°á»›c",
    "loai_chi": "Ä‚n uá»‘ng",
    "nguon_tien": "Tech MÃ¨o"
  }
}
```

---

### ğŸ“„ Map sang CSDL

| Field payload | Sheet `Chi_Tieu_2026` | Ghi chÃº                       |
| ------------- | --------------------- | ----------------------------- |
| ngay          | NgÃ y                  | Date                          |
| so_tien       | Sá»‘ tiá»n               | **giÃ¡ trá»‹ gá»‘c**               |
| mo_ta         | MÃ´ táº£                 | ÄÃ£ gá»™p                        |
| loai_chi      | Loáº¡i chi              | Dropdown tá»« `loai_chi_active` |
| nguon_tien    | Nguá»“n tiá»n            | Dropdown tá»« `nguon_tien`      |
| âŒ             | Sá»‘ dÆ° LT              | **Sheet tá»± tÃ­nh**             |

---

### ğŸ”’ Validation (app-side)

* `so_tien > 0`
* `loai_chi` âˆˆ `loai_chi_active`
* `nguon_tien` âˆˆ `nguon_tien.active`
* `mo_ta` â‰  rá»—ng

---

# 2ï¸âƒ£ PAYLOAD: THU NHáº¬P

### ğŸ¯ Má»¥c tiÃªu

Ghi **1 dÃ²ng** vÃ o sheet `Thu_2026`

---

### ğŸ“Œ Payload (JSON)

```json
{
  "type": "thu",
  "payload": {
    "ngay": "2026-01-20",
    "so_tien": 200000,
    "mo_ta": "lÃ£i tech",
    "loai_thu": "NgÃ¢n hÃ ng",
    "nguon_tien": "Tech MÃ¨o"
  }
}
```

---

### ğŸ“„ Map sang CSDL

| Field payload | Sheet `Thu_2026` | Ghi chÃº           |
| ------------- | ---------------- | ----------------- |
| ngay          | NgÃ y             | Date              |
| so_tien       | Thu              | GiÃ¡ trá»‹ gá»‘c       |
| mo_ta         | MÃ´ táº£            | Text              |
| loai_thu      | Loáº¡i thu         | String            |
| nguon_tien    | Nguá»“n tiá»n       | Dropdown          |
| âŒ             | Tá»•ng thu         | **Sheet tá»± tÃ­nh** |

---

### ğŸ“Œ DÃ²ng Ä‘áº·c biá»‡t (khá»Ÿi táº¡o)

```json
{
  "type": "thu",
  "payload": {
    "ngay": "2026-01-04",
    "so_tien": 191616700,
    "mo_ta": "dÆ° nÄƒm trÆ°á»›c",
    "loai_thu": "DÆ° nÄƒm trÆ°á»›c",
    "nguon_tien": "Sá»‘ dÆ° Ä‘áº§u nÄƒm"
  }
}
```

---

# 3ï¸âƒ£ PAYLOAD: Tá»”NG Káº¾T (TK)

### ğŸ¯ Má»¥c tiÃªu

* Ghi **1 dÃ²ng** vÃ o `tk_session`
* Ghi **N dÃ²ng** vÃ o `tk_detail`
* **KHÃ”NG sinh Thu / Chi**

---

### ğŸ“Œ Payload (JSON)

```json
{
  "type": "tk",
  "payload": {
    "session_id": "s4",
    "ngay_tk": "2026-01-20",
    "so_du_lt": 1408747185,
    "chi_tiet": [
      { "nguon_tien": "Tech MÃ¨o", "so_du_tt": 653251022 },
      { "nguon_tien": "ACB MÃ¨o", "so_du_tt": 238050000 },
      { "nguon_tien": "Tiá»n máº·t BoÃ©", "so_du_tt": 8000000 }
    ],
    "note": "tá»•ng káº¿t tuáº§n 3"
  }
}
```

---

### ğŸ“„ Map sang CSDL

#### Sheet `tk_session`

| Field      | Cá»™t                                    |
| ---------- | -------------------------------------- |
| session_id | session_id                             |
| ngay_tk    | ngay_tk                                |
| so_du_lt   | so_du_lt                               |
| so_du_tt   | so_du_tt *(app tÃ­nh tá»•ng)*             |
| chenh_lech | chenh_lech *(Sheet hoáº·c app Ä‘á»u Ä‘Æ°á»£c)* |
| status     | status = `"confirmed"`                 |
| note       | note                                   |

#### Sheet `tk_detail`

| Field      | Cá»™t        |
| ---------- | ---------- |
| session_id | session_id |
| nguon_tien | nguon_tien |
| so_du_tt   | so_du_tt   |

---

### ğŸ”’ Validation

* `session_id` **duy nháº¥t**
* `nguon_tien` âˆˆ `nguon_tien.active`
* `so_du_tt â‰¥ 0`
* `chi_tiet.length â‰¥ 1`

---

# 4ï¸âƒ£ Gá»¢I Ã API ENDPOINT (GAS)

```
POST /append
```

Body:

```json
{ type, payload }
```

GAS:

```js
switch(type) {
  case "chi": appendChi(payload); break;
  case "thu": appendThu(payload); break;
  case "tk":  appendTK(payload);  break;
}
```

---

# âœ… TRáº NG THÃI CUá»I

* âœ” Payload **khá»›p 1â€“1 vá»›i CSDL**
* âœ” KhÃ´ng gá»­i dÆ° cá»™t
* âœ” KhÃ´ng phá»¥ thuá»™c cÃ´ng thá»©c app
* âœ” Code theo lÃ  cháº¡y, **khÃ´ng cáº§n há»i láº¡i**

---


Ok, mÃ¬nh viáº¿t **INTERFACE FINAL (TypeScript)** Ä‘Ãºng **payload spec + MP + CSDL**.
Báº¡n copy dÃ¹ng tháº³ng cho frontend (React/Vue/JS thuáº§n Ä‘á»u ok).

---

# ğŸ“ TYPE / INTERFACE â€“ FINAL

> NguyÃªn táº¯c:
>
> * 1 interface = 1 payload
> * KhÃ´ng field thá»«a
> * KhÃ´ng field cÃ´ng thá»©c
> * String = Ä‘Ãºng chuáº©n trong Sheet

---

## 1ï¸âƒ£ ENUM / TYPE DÃ™NG CHUNG

```ts
export type PayloadType = "chi" | "thu" | "tk";
```

---

## 2ï¸âƒ£ CHI TIÃŠU (Expense)

### Payload gá»­i Ä‘i

```ts
export interface ChiPayload {
  ngay: string;        // YYYY-MM-DD
  so_tien: number;     // > 0
  mo_ta: string;       // gá»™p, khÃ´ng rá»—ng
  loai_chi: string;    // tá»« loai_chi.ten_loai_chi
  nguon_tien: string; // tá»« nguon_tien.ten_nguon_tien
}
```

### Wrapper request

```ts
export interface ChiRequest {
  type: "chi";
  payload: ChiPayload;
}
```

---

## 3ï¸âƒ£ THU NHáº¬P (Income)

### Payload gá»­i Ä‘i

```ts
export interface ThuPayload {
  ngay: string;        // YYYY-MM-DD
  so_tien: number;     // > 0
  mo_ta: string;
  loai_thu: string;    // string tá»± do (NgÃ¢n hÃ ng, NhÃ  trá»...)
  nguon_tien: string; // tá»« nguon_tien
}
```

### Wrapper request

```ts
export interface ThuRequest {
  type: "thu";
  payload: ThuPayload;
}
```

---

## 4ï¸âƒ£ Tá»”NG Káº¾T â€“ SNAPSHOT (TK)

### Chi tiáº¿t tá»«ng nguá»“n tiá»n

```ts
export interface TKDetail {
  nguon_tien: string; // tá»« nguon_tien
  so_du_tt: number;   // >= 0
}
```

### Payload tá»•ng káº¿t

```ts
export interface TKPayload {
  session_id: string;     // vd: s4
  ngay_tk: string;        // YYYY-MM-DD
  so_du_lt: number;       // load tá»« Sheet
  chi_tiet: TKDetail[];   // >= 1 dÃ²ng
  note?: string;          // optional
}
```

### Wrapper request

```ts
export interface TKRequest {
  type: "tk";
  payload: TKPayload;
}
```

---

## 5ï¸âƒ£ UNION TYPE â€“ REQUEST CHUNG

ğŸ‘‰ DÃ¹ng cho API `POST /append`

```ts
export type AppRequest =
  | ChiRequest
  | ThuRequest
  | TKRequest;
```

---

## 6ï¸âƒ£ TYPE DÃ™NG TRONG UI (KHÃ”NG Gá»¬I API)

### Nguá»“n tiá»n (dropdown, render icon)

```ts
export interface NguonTien {
  ten_nguon_tien: string;
  icon?: string;
  active: boolean;
}
```

### Loáº¡i chi (dropdown)

```ts
export interface LoaiChi {
  ten_loai_chi: string;
  active: boolean;
  sort_order?: number;
}
```

### Calculator temp list

```ts
export interface TempItem {
  id: string;
  value: number;
}
```

---

## 7ï¸âƒ£ VALIDATION HELPER (Gá»¢I Ã)

```ts
export function isPositiveNumber(n: number): boolean {
  return Number.isFinite(n) && n > 0;
}
```

---

## 8ï¸âƒ£ VÃ Dá»¤ Sá»¬ Dá»¤NG

```ts
const req: ChiRequest = {
  type: "chi",
  payload: {
    ngay: "2026-01-20",
    so_tien: 55000,
    mo_ta: "Ä‘i chá»£ + tiá»n nÆ°á»›c",
    loai_chi: "Ä‚n uá»‘ng",
    nguon_tien: "Tech MÃ¨o"
  }
};
```

---

## âœ… CHá»T CUá»I

* âœ” Interface **khá»›p tuyá»‡t Ä‘á»‘i payload spec**
* âœ” KhÃ´ng dÆ° field
* âœ” Frontend code xong â†’ GAS nháº­n lÃ  cháº¡y
* âœ” Sau nÃ y thÃªm icon / meta **khÃ´ng cáº§n sá»­a interface gá»­i API**

---



