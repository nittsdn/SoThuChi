Ok, mÃ¬nh **Ä‘Ã£ chá»‰nh láº¡i MP cho ÄÃšNG 100% vá»›i CSDL má»›i** (thÃªm IDChi/IDThu tá»± sinh, cáº­p nháº­t header Chi/Thu) vÃ  **Ä‘Ã³ng MP á»Ÿ tráº¡ng thÃ¡i â€œÄ‘á»§ Ä‘á»ƒ code â€“ khÃ´ng pháº£i quay láº¡i sá»­aâ€**.
DÆ°á»›i Ä‘Ã¢y lÃ  **MP FINAL (Ä‘Ã£ Ä‘á»“ng bá»™ Chi / Thu / TK / loai_chi / nguon_tien vá»›i CSDL má»›i)**. Báº¡n cÃ³ thá»ƒ **copy lÆ°u láº¡i lÃ m tÃ i liá»‡u gá»‘c**.

---

# MASTER PLAN APP Sá»” THU CHI â€“ FINAL (SYNC WITH CSDL Má»šI)

> **NguyÃªn táº¯c xuyÃªn suá»‘t**
>
> * App **chá»‰ nháº­p & gá»­i dá»¯ liá»‡u gá»‘c**
> * Google Sheet **tÃ­nh toÃ n bá»™ cÃ´ng thá»©c**
> * KhÃ´ng suy diá»…n, khÃ´ng tÃ­nh thay Sheet
> * Tá»•ng káº¿t = snapshot, khÃ´ng sinh Thu/Chi

---

## 1ï¸âƒ£ Tá»”NG QUAN Há»† THá»NG

* Web App (SPA)
* Database: **Google Sheets**
* KhÃ´ng API ngÃ¢n hÃ ng
* KhÃ´ng backend phá»©c táº¡p
* LocalStorage: chá»‰ lÆ°u **UI settings**
* CSDL lÃ  **source of truth**

---

## 2ï¸âƒ£ Cáº¤U TRÃšC CSDL (Ä‘Ã£ chá»‘t)

### CÃ¡c sheet chÃ­nh:

* `Chi_Tieu_2026`
* `Thu_2026`
* `loai_chi`
* `nguon_tien`
* `tk_session`
* `tk_detail`

### Header cáº­p nháº­t:

- **Chi_Tieu_2026**: IDChi (tá»± sinh), Chi tiÃªu, Loáº¡i chi, Nguá»“n tiá»n, Sá»‘ tiá»n (/1000), Sá»‘ tiá»n vnÄ‘, NgÃ y, Sá»‘ dÆ° lÃ½ thuyáº¿t
- **Thu_2026**: Thu, NgÃ y, MÃ´ táº£, Nguá»“n tiá»n, Loáº¡i thu, Tá»•ng thu, IDThu (tá»± sinh)

---

## 3ï¸âƒ£ QUY Æ¯á»šC Dá»® LIá»†U CHUNG (Ráº¤T QUAN TRá»ŒNG)

### ğŸ”’ Nguá»“n tiá»n

* `Chi / Thu.Nguá»“n tiá»n`
* **= nguon_tien.ten_nguon_tien (string tuyá»‡t Ä‘á»‘i)**
* App **chá»‰ cho chá»n dropdown**, khÃ´ng gÃµ tay

### ğŸ”’ Loáº¡i chi

* `Chi_Tieu_2026.Loáº¡i chi`
* **= loai_chi.ten_loai_chi**
* Dropdown tá»« `loai_chi_active` (active = TRUE)

### ğŸ”’ ID tá»± sinh

* IDChi/IDThu: Sheet/GAS tá»± táº¡o (e.g., C1, T1), app khÃ´ng gá»­i

---

## 4ï¸âƒ£ GIAO DIá»†N & LUá»’NG NGÆ¯á»œI DÃ™NG

---

## A. HEADER & SETTINGS

### Header

* TÃªn app
* NgÃ y hiá»‡n táº¡i
* ThÃ´ng bÃ¡o chi/thu gáº§n nháº¥t

### Settings

* Chá»n 8 mÃ´ táº£ chi thÆ°á»ng dÃ¹ng
* LÆ°u LocalStorage
* **KhÃ´ng lÆ°u dá»¯ liá»‡u tiá»n**

---

## B. PHáº¦N CHI TIÃŠU (EXPENSE)

### 1. Calculator (GIá»® NGUYÃŠN)

* `tempList = [{ id, value }]`
* Add / Edit / Confirm / Delete
* Reset toÃ n bá»™

### 2. MÃ´ táº£

* 8 chip nhanh
* Dropdown
* Text tá»± do
* Báº¯t buá»™c â‰¥ 1 mÃ´ táº£
* App gá»™p thÃ nh **1 chuá»—i mÃ´ táº£**

### 3. Loáº¡i chi

* 1 dropdown
* Load tá»«:

  ```
  loai_chi_active
  ```
* KhÃ´ng cho nháº­p tay

### 4. Nguá»“n tiá»n

* 1 dropdown
* Load tá»«:

  ```
  nguon_tien WHERE active = TRUE
  ```
* Báº¯t buá»™c chá»n

### 5. Submit Chi

App gá»­i:

* `ngay`
* `tong_tien` (tá»•ng tempList)
* `mo_ta` (Ä‘Ã£ gá»™p)
* `loai_chi`
* `nguon_tien`

ğŸ‘‰ Sheet:

* tá»± tÃ­nh sá»‘ dÆ° lÃ½ thuyáº¿t
* tá»± sinh IDChi

---

## C. PHáº¦N THU NHáº¬P (INCOME)

âš ï¸ **Giá»‘ng Chi 95%**

KhÃ¡c:

* CÃ³:

  * Nguá»“n tiá»n (báº¯t buá»™c)
  * Loáº¡i thu
* CÃ³ thá»ƒ cÃ³ dÃ²ng Ä‘áº·c biá»‡t:

  * â€œKhá»Ÿi táº¡o sá»‘ dÆ° / dÆ° nÄƒm trÆ°á»›câ€

### Submit Thu

App gá»­i:

* `ngay`
* `so_tien`
* `mo_ta`
* `nguon_tien`
* `loai_thu`

ğŸ‘‰ Sheet:

* tá»± tÃ­nh tá»•ng thu
* tá»± sinh IDThu

---

## D. PHáº¦N Tá»”NG Káº¾T (SUMMARY â€“ ÄÃƒ CHUáº¨N HOÃ)

### 1. Load dá»¯ liá»‡u

* Load:

  * sá»‘ dÆ° lÃ½ thuyáº¿t (tá»« Sheet)
  * danh sÃ¡ch nguá»“n tiá»n (active)

### 2. Render UI Ä‘á»™ng

* Vá»›i má»—i `nguon_tien`:

  * 1 input sá»‘ dÆ° thá»±c
* App:

  * auto cá»™ng `so_du_tt`

### 3. TÃ­nh toÃ¡n

* `chenhlech = so_du_lt - so_du_tt`
* Hiá»ƒn thá»‹ ngay

### 4. Submit Tá»•ng káº¿t

Khi nháº¥n:

* ghi:

  * 1 dÃ²ng `tk_session`
  * N dÃ²ng `tk_detail`
* **KHÃ”NG sá»­a Chi / Thu**

---

## 4. LOGIC Ká»¸ THUáº¬T (UPDATED)

### 4.1 State Management

* tempList (Chi / Thu)
* editingIndex
* selectedNguonTien
* tkInputs = { nguon_tien: so_du }

---

### 4.2 NguyÃªn táº¯c vÃ ng

* Sheet:

  * lo cÃ´ng thá»©c
* App:

  * chá»‰ gá»­i dá»¯ liá»‡u gá»‘c
* TK:

  * snapshot, khÃ´ng suy diá»…n

---

## âœ… Káº¾T LUáº¬N CUá»I

* MP má»›i:

  * âœ” khá»›p CSDL
  * âœ” khÃ´ng dÆ° tÃ­nh nÄƒng
  * âœ” khÃ´ng mÃ¢u thuáº«n logic
* Tá»« giá»:

  * **MP Ä‘Ã£ Ä‘Ã³ng**
  * code theo MP, khÃ´ng suy diá»…n thÃªm

---

### BÆ°á»›c tiáº¿p theo há»£p lÃ½ nháº¥t:

* Viáº¿t **API contract (payload)**:

  * Chi
  * Thu
  * TK
    â†’ Ä‘á»ƒ code front & GAS khÃ´ng lá»‡ch nhau.

Náº¿u báº¡n muá»‘n, nÃ³i **â€œviáº¿t payload specâ€**, mÃ¬nh lÃ m ngay.

---

## 1ï¸âƒ£ Payload Spec Chi

### Payload chi

```ts
export interface ChiPayload {
  ngay: string;        // YYYY-MM-DD
  so_tien: number;     // > 0 (tá»•ng nghÃ¬n)
  mo_ta: string;
  loai_chi: string;    // tá»« loai_chi
  nguon_tien: string;  // tá»« nguon_tien
}
```

### Wrapper request

```ts
export interface ChiRequest {
  type: "chi";
  payload: ChiPayload;
}
```

## 2ï¸âƒ£ Payload Spec Thu

### Payload thu

```ts
export interface ThuPayload {
  ngay: string;        // YYYY-MM-DD
  so_tien: number;     // > 0 (VNÄ, app *1000)
  mo_ta: string;
  loai_thu: string;    // string tá»± do
  nguon_tien: string;  // tá»« nguon_tien
}
```

### Wrapper request

```ts
export interface ThuRequest {
  type: "thu";
  payload: ThuPayload;
}
```

## 3ï¸âƒ£ Payload Spec TK

### Chi tiáº¿t tá»«ng nguá»“n tiá»n

```ts
export interface TKDetail {
  nguon_tien: string; // tá»« nguon_tien
  so_du_tt: number;   // >= 0 (VNÄ)
}
```

### Payload tá»•ng káº¿t

```ts
export interface TKPayload {
  session_id: string;     // vd: s4
  ngay_tk: string;        // YYYY-MM-DD
  so_du_lt: number;       // load tá»« Sheet (VNÄ)
  chi_tiet: TKDetail[];   // >= 1 dÃ²ng
  note?: string;          // optional
}
```

### Wrapper request

```ts
export interface TKRequest {
  type: "tk";
  payload: TKPayload;
}
```

---

## 5ï¸âƒ£ UNION TYPE â€“ REQUEST CHUNG

ğŸ‘‰ DÃ¹ng cho API `POST /append`

```ts
export type AppRequest =
  | ChiRequest
  | ThuRequest
  | TKRequest;
```

---

## 6ï¸âƒ£ TYPE DÃ™NG TRONG UI (KHÃ”NG Gá»¬I API)

### Nguá»“n tiá»n (dropdown, render icon)

```ts
export interface NguonTien {
  ten_nguon_tien: string;
  icon?: string;
  active: boolean;
}
```

### Loáº¡i chi (dropdown)

```ts
export interface LoaiChi {
  ten_loai_chi: string;
  active: boolean;
  sort_order?: number;
}
```

### Calculator temp list

```ts
export interface TempItem {
  id: string;
  value: number;
}
```

---

## 7ï¸âƒ£ VALIDATION HELPER (Gá»¢I Ã)

```ts
export function isPositiveNumber(n: number): boolean {
  return Number.isFinite(n) && n > 0;
}
```

---

## 8ï¸âƒ£ VÃ Dá»¤ Sá»¬ Dá»¤NG

```ts
const req: ChiRequest = {
  type: "chi",
  payload: {
    ngay: "2026-01-20",
    so_tien: 55,  // nghÃ¬n
    mo_ta: "Ä‘i chá»£ + tiá»n nÆ°á»›c",
    loai_chi: "Ä‚n uá»‘ng",
    nguon_tien: "Tech MÃ¨o"
  }
};
```

---

## âœ… CHá»T CUá»I

* âœ” Interface **khá»›p tuyá»‡t Ä‘á»‘i payload spec**
* âœ” KhÃ´ng dÆ° field
* âœ” Frontend code xong â†’ GAS nháº­n lÃ  cháº¡y
* âœ” Sau nÃ y thÃªm icon / meta **khÃ´ng cáº§n sá»­a interface gá»­i API**

---